代办：
[X]1. 需要看9633 An14 在哪里设置 persist.sys.prev.apk属性。（不需要确认）
[x]2. 确定TvInputService.Sessioin tune 回调调用栈
3. TvView.setMain 的作用。
[X]4. session 在什么情况下，会分发按键事件？(在TvView中会给session分发按键事件)
5. 权限问题待确认，比如为啥sber可以查到所有的节目信息？理论上是需要ACCESS_ALL_EPG_DATA 权限
6. channel id
[x]7. tv Setting与Api层级关系图重写。


1、tif做了哪些事情，各个组件之间的关系，是怎么分层的，怎么协同的


2、sourceid inputid inputlist session这些常见的数据是怎么传递的，作用是什么
3、最好以一个例子从代码端分析TVAPI与TIF之间的联系，例如节目播放、切换等


1.1 tif 简单介绍，与非TIF的区别。
1.2 tv.db介绍（sourceId，inputId这些数据的来源）
sourceId、channelId的作用：实现TIF 播放TV的基本demo
tv.db:介绍 （补充搜台过程？）
1.3 LiveTV、TvApi、AndroidTIF接口与vendor之间的角色、分层。
1.4 调试技巧：

1.5 问题案例:

 - (STR待机有一段时间有声音的问题)[https://kb.cvte.com/pages/viewpage.action?pageId=418024281]

 - (添加CI加密状态需求)[https://kb.cvte.com/pages/viewpage.action?pageId=410028367]



 参考文档；
 - [MT9633 TIF 流程分析](https://kb.cvte.com/pages/viewpage.action?pageId=433453166)
 - [TIF](https://kb.cvte.com/display/TeamTVSW/TIF)
 - [950S AN14方案TIF](https://kb.cvte.com/pages/viewpage.action?pageId=422281547)
 - [电视输入框架-官方说明](https://source.android.google.cn/devices/tv)



 TVProvider:

权限限制：
```java

 private SqlParams createSqlParams(String operation, Uri uri, String selection,
         String[] selectionArgs) {
     int match = sUriMatcher.match(uri);
     SqliteTokenFinder.findTokens(selection, p -> {
         if (p.first == SqliteTokenFinder.TYPE_REGULAR
                 && TextUtils.equals(p.second.toUpperCase(Locale.US), "SELECT")) {
             // only when a keyword is not in quotes or brackets
             // see https://www.sqlite.org/lang_keywords.html
             android.util.EventLog.writeEvent(0x534e4554, "135269669", -1, "");
             throw new SecurityException(
                     "Subquery is not allowed in selection: " + selection);
         }
     });
     SqlParams params = new SqlParams(null, selection, selectionArgs);
     // Control access to EPG data (excluding watched programs) when the caller doesn't have all
     // access.
     String prefix = match == MATCH_CHANNEL ? CHANNELS_TABLE + "." : "";

     // 如果没有 com.android.providers.tv.permission.ACCESS_ALL_EPG_DATA 权限，就需要限制包的访问权限
     if (!callerHasAccessAllEpgDataPermission()
             && match != MATCH_WATCHED_PROGRAM && match != MATCH_WATCHED_PROGRAM_ID) {
         if (!TextUtils.isEmpty(selection)) {
             throw new SecurityException("Selection not allowed for " + uri);
         }
         // 将操作限制为调用包拥有的数据，但调用方尝试读取 TV 列表并具有相应的权限。

         if (operation.equals(OP_QUERY) && callerHasReadTvListingsPermission()) {
             params.setWhere(prefix + BaseTvColumns.COLUMN_PACKAGE_NAME + "=? OR "  
                     + Channels.COLUMN_SEARCHABLE + "=?", getCallingPackage_(), "1");
         } else {
             params.setWhere(prefix + BaseTvColumns.COLUMN_PACKAGE_NAME + "=?",
                     getCallingPackage_());
         }
     }
     String packageName = uri.getQueryParameter(TvContract.PARAM_PACKAGE);
     if (packageName != null) {
         params.appendWhere(prefix + BaseTvColumns.COLUMN_PACKAGE_NAME + "=?", packageName);
     }

```



# LiveTV 与 TvApi关系

## launcher进入TV -- 直接打开TvSupportActivity

```uml

@startuml

skinparam BoxPadding 10

Launcher -> TvSupportActivity:startActivity()

box "Tv Api"
participant TvSupportActivity
participant TvPlayerTifImpl
participant TvView
end box

box "TvSetting"
participant TvSettingActivity
end box


TvSupportActivity -> TvSupportActivity:handleIntent()

TvSupportActivity -> TvPlayerTifImpl:tune()

TvPlayerTifImpl -> TvView:tune()


TvSupportActivity -> TvPlayerTifImpl:gotoTargetActivity()


TvPlayerTifImpl -> TvSettingActivity:startActivity()

@enduml

```

## launcher进入TV -- 打开TvSetting

```uml

@startuml

skinparam BoxPadding 10

Launcher -> TvSettingActivity:startActivity()

TvSettingActivity -> ITVApiScreenWindowAidl:eventScreenWindowMute(false)

ITVApiScreenWindowAidl -> TVApiScreenDisplayImpl:eventScreenWindowMute(false)
note right ITVApiScreenWindowAidl
通过binder跨进程调用
end note


TVApiScreenDisplayImpl -> AmlScreenManager:setScreenMute(false)


AmlScreenManager -> TvPlayerTifImpl:isTifAlive()

TvPlayerTifImpl --> AmlScreenManager:返回tif状态

AmlScreenManager -> AmlInputSourceManager:setCurrentInputSource()

AmlScreenManager -> AmlInputSourceManager:tuneCurrentInputSource(false)

AmlInputSourceManager -> AmlInputSourceManager:sendMessage(MSG_TUNE_SOURCE)

AmlInputSourceManager -> TvPlayerTifImpl:tune(sourceId)


TvPlayerTifImpl -> TvPlayerTifImpl:isTifAlive()


TvPlayerTifImpl -> TvSupportActivity:startActivity()


TvSupportActivity -> TvSupportActivity:handleIntent()

TvSupportActivity -> TvPlayerTifImpl:tune(intent)


TvPlayerTifImpl -> TvView:tune()


TvSupportActivity -> TvPlayerTifImpl:gotoTargetActivity()


TvPlayerTifImpl -> TvSettingActivity:startActivity()


box "TvSetting"
participant TvSettingActivity
participant ITVApiScreenWindowAidl
end box

box "Tv Api"
participant TVApiScreenDisplayImpl
participant AmlScreenManager
participant AmlInputSourceManager
participant TvPlayerTifImpl
participant TvSupportActivity
participant TvView
end box


@enduml


```


# 切通道流程：

```java
@startuml
skinparam BoxPadding 10

box "TvSetting端"
participant View
participant ITVApiSystemInputSourceAidl

end box


box "TvApi端"
participant TVApiSystemInputSourceImpl
participant AmlInputSourceManager
participant TvPlayerTifImpl
participant TIFCommonUtil
participant TvView

end box

View -> ITVApiSystemInputSourceAidl:eventSystemInputSourceSetInputSource(sourceId)

ITVApiSystemInputSourceAidl -> TVApiSystemInputSourceImpl:eventSystemInputSourceSetInputSource()

TVApiSystemInputSourceImpl -> AmlInputSourceManager:setCurrentInputSourceById()
note left AmlInputSourceManager
   将设置的sourceId保存在 Settings#TV_CURRENT_DEVICE_ID
end note

TVApiSystemInputSourceImpl -> AmlInputSourceManager:tuneCurrentInputSource()


AmlInputSourceManager -> TvPlayerTifImpl:tune(sourceId)


TvPlayerTifImpl -> TvPlayerTifImpl:isTifAlive()返回true


TvPlayerTifImpl -> TIFCommonUtil:getInputIdBySourceId(sourceId)

TIFCommonUtil --> TvPlayerTifImpl:返回InputId

TvPlayerTifImpl -> TvView:tune()

@enduml

```

# 切节目流程

```java
@startuml

skinparam BoxPadding 10

box "TvSetting端"
participant View
participant ITVApiTvChannelsAidl
end box


box "TvApi端"
participant TVApiTvChannelsImpl
participant AmlChannelManager
participant TvPlayerTifImpl
participant TvView
end box


View -> ITVApiTvChannelsAidl:eventTVChannelsTuneChannelById(channelId)

ITVApiTvChannelsAidl -> TVApiTvChannelsImpl:eventTVChannelsTuneChannelById(channelId)

TVApiTvChannelsImpl -> AmlChannelManager:tuneChannelById(channelId)

AmlChannelManager -> TvPlayerTifImpl:tune(sourceId)
TvPlayerTifImpl -> TvView:tune(inputId)

@enduml

```

# 创建session的过程

```java
@startuml
skinparam BoxPadding 10

box "TvApi端"
participant TvView

participant TvInputManager
participant TvView.MySessionCallback
participant TvInputManager.Session
participant ITvInputClient.Stub
end box


?-> TvView:tune()

TvView -> TvInputManager:createSession()
note right TvView
   如果当前还没有创建seasion
end note



box "InputManagerService端"
participant ITvInputClient
participant BinderService
participant ITvInputService
participant SessionCallback
end box


TvInputManager -> BinderService:createSession() 
note left BinderService
   通过binder调用服务端接口
end note

BinderService -> ITvInputService:createSession()

box "TvInput端"
participant ITvInputService.Stub
participant TvInputService
end box

ITvInputService -> ITvInputService.Stub:createSession()
note left ITvInputService.Stub
   通过binder调用TvInput端接口
end note


ITvInputService.Stub -> TvInputService:通过ServiceHandler调用\nonCreateSession()

TvInputService --> SessionCallback :onSessionCreated()
note left TvInputService
   返回创建好的ITvInputSession代理对象
end note


SessionCallback --> ITvInputClient:onSessionCreated()

ITvInputClient --> ITvInputClient.Stub:onSessionCreated()

ITvInputClient.Stub --> TvView.MySessionCallback:onSessionCreated()

TvView.MySessionCallback -> TvInputManager.Session:sendAppPrivateCommand()

TvView.MySessionCallback -> TvInputManager.Session:tune()
@enduml

```

# turn channel的过程



```java
@startuml
skinparam BoxPadding 10

box "TvApi端"
participant TvView
participant TvInputManager.Session
end box


?-> TvView:tune()

TvView -> TvInputManager.Session:tune()


box "InputManagerService端"
participant BinderService
participant InputManagerService
participant ITvInputSession
end box


TvInputManager.Session -> BinderService:tune() 
note left BinderService
   传递 sessionToken
end note

BinderService -> InputManagerService:getSessionLocked()
note right BinderService
   通过 sessionToken 找到 ITvInputSession
end note

InputManagerService --> BinderService: 返回 ITvInputSession 对象


BinderService -> ITvInputSession:tune()


box "TvInput端"
participant ITvInputSessionWrapper
participant TvInputService.Session
end box


ITvInputSession -> ITvInputSessionWrapper:tune()

ITvInputSessionWrapper -> TvInputService.Session:tune()

@enduml

```
